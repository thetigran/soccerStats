<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer League</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rowdies:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }

        header {
            background-color: #585858; /* Grey background */
            padding: 30px 20px;
            text-align: center;
            border-bottom: 2px solid #2d2d2d;
        }

        header h1 {
            margin: 0;
            font-size: 3rem; /* Bigger letters */
            font-weight: bold;
            color: white;
            font-family: 'Rowdies', sans-serif;
            font-weight: 700;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background-color: #888;
            border-bottom: 2px solid #2d2d2d;
            padding: 10px 0;
            text-align: center;
            font-family: 'Rowdies', sans-serif;
        }

        nav a {
            color: #ffffff;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
            font-size: 1.3em;
        }


        /* Responsive Navigation */
        @media screen and (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: center;
            }
            nav a {
                display: block;
                margin: 10px 0;
                font-size: 1.1em;
            }
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
        }

        @media screen and (max-width: 768px) {
            .menu-toggle {
                display: block;
                margin: 10px;
            }
            .nav-links {
                display: none;
                flex-direction: column;
                width: 100%;
                text-align: center;
            }
            .nav-links a {
                display: block;
                padding: 10px;
            }
            .nav-links.active {
                display: flex;
            }
        }

        nav a:hover {
            text-decoration: underline;
        }

        .upcoming-match {
            background-color: #e0f7fa;
            color: #00796b;
            border-left: 4px solid #00796b;
            padding: 10px;
            font-size: 14px;
            margin: 20px auto;
            width: 100%;
            text-align: center;
            align-items: center;
            position: relative;
            width: 100%;
            max-width: 600px;
            font-family: 'Rowdies', sans-serif;
        }

        main {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .section {
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
            text-align: center;
            color: #ffffff
        }

        .section h2 {
            border-bottom: 2px solid #154c79;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .top-players h2 {
            border-bottom: 2px solid #154c79;
            padding-bottom: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Rowdies', sans-serif;
        }

        .top-players {
            padding-bottom: 15px;
            text-align: center;
            margin-bottom: 1px;
            color: #ffffff;
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 1000px;
            flex-wrap: wrap;
        }
        
        .table-container {
            margin-bottom: 1px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1px;
        }

        th, td {
            border: 1px solid #2d2d2d;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        .see-more {
            text-align: center;
            margin-top: 5px;
        }

        .see-more a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            margin: 20px auto;
            border-radius: 30px;
            background-color: white;
            color: black;
            font-family: 'Rowdies', cursive;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid black;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .see-more a:hover {
            background-color: #d3d3d3; /* Light grey */
            color: black;
        }

        footer {
            text-align: center;
            padding: 20px;
            background-color: #1e1e1e;
            border-top: 2px solid #2d2d2d;
        }

        footer p {
            margin: 0;
            font-size: 0.9rem;
        }


        /* Responsive layout for small screens */
        @media screen and (max-width: 768px) {
            .top-players {
                flex-direction: column;
                align-items: center;
            }

            .table-container {
                width: 100%;
                margin-bottom: 20px;
            }

            table {
                width: 100%;
            }

            .see-more {
                width: 100%;
                text-align: center;
            }
        }

                
        /* Container for the match */
        .match-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 10px;
            position: relative;
            width: 100%;
            max-width: 600px;
            text-align: center;
            font-family: 'Rowdies', sans-serif;
        }

        .match-teams {
            font-size: 18px;
            text-align: center;
            margin-bottom: 8px;
            color: #888;
        }

        .match-score {
            font-size: 36px;
            text-align: center;
            color: #888;
            margin: 0 20px;
            flex-shrink: 0;
        }

        .score {
            font-size: 32px;
            color: #ffffff;
            font-weight: bold;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between circles and score */
        }

        .score-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .match-date {
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
            color: #00796b;
        }

        .match-players {
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #333;
        }

        /* Container for winners and losers */
        .result-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
            width: 100%;
        }

        /* Styling for winners and losers sections */
        .winners{
            width: 45%;
            text-align: center;
            font-size: 40px;
            margin-bottom: 10px;
            color: #006eff;
/*            background-color: #28a745;*/
            padding: 5px 10px;
            border-radius: 5px;
            flex: 1;
            font-family: 'Rowdies', sans-serif;
        }

        .losers {
            width: 45%;
            text-align: center;
            font-size: 40px;
            margin-bottom: 10px;
            color: #dc3545;
            /*background-color: #dc3545;*/
            padding: 5px 10px;
            border-radius: 5px;
            flex: 1;
            font-family: 'Rowdies', sans-serif;
        }

        /* List styling for players */
        .players-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .player-item {
            font-size: 14px;
            margin: 4px 0;
        }

        .player-item span {
            display: inline-block;
            margin-right: 8px;
        }

        .group-image {
            width: 100%; /* Adjust width as necessary */
            max-height: 100%; /* Limit the height */
            object-fit: cover; /* Maintain aspect ratio */
            margin-top: 10px;
            border-radius: 8px;
        }

        .load-more-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            border-radius: 30px;
            background-color: white;
            color: black;
            font-family: 'Rowdies', cursive;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid black;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .load-more-btn:hover {
            background-color: #d3d3d3; /* Light grey */
            color: black;
        }

    </style>
    <script>
        if (localStorage.getItem("authenticated") !== "true") {
            window.location.href = "entry.html"; // Redirect to entry.html if not authenticated
        }
    </script>    
    <script>
        async function fetchTopPlayers() {
            const airtableApiKey = 'patp3kkpRn8eGNX3y.db99d2833bad3cfb3ed32a4377304090f84839a464e55ffc8b1333a01cb5fdf3';
            const airtableBaseId = 'app9PTtjDQsuwHyIz';
            const tableName = 'Table 1';

            const url = `https://api.airtable.com/v0/${airtableBaseId}/${tableName}`;
            try {
                const response = await fetch(url, {
                    headers: {
                        Authorization: `Bearer ${airtableApiKey}`
                    }
                });

                if (!response.ok) {
                    console.error('Failed to fetch data');
                    return;
                }

                const data = await response.json();

                const rows = data.records;
        
                const playerStats = {};
        
                rows.forEach(row => {
                    const fields = row.fields;
                    const player = fields['Jugador'];

                    // Check if the player name is valid (non-empty, non-null)
                    if (!player) {
                        return; // Skip this row if no player name is provided
                    }
                    
                    if (!playerStats[player]) {
                        playerStats[player] = {
                            jugador: player,
                            goles: 0,
                            asistencias: 0,
                            penaltisProvocados: 0,
                            faltasProvocadas: 0,
                            penaltisParados: 0,
                            partidosJugados: 0,
                            partidosGanados: 0,
                            golesPropia: 0,
                            golesContribuidos: 0,
                            puntosMVP: 0
                        };
                    }
        
                    playerStats[player].goles += parseInt(fields['Goles'] || 0, 10);
                    playerStats[player].asistencias += parseInt(fields['Asistencias'] || 0, 10);
                    playerStats[player].penaltisProvocados += parseInt(fields['Penaltis Provocados'] || 0, 10);
                    playerStats[player].faltasProvocadas += parseInt(fields['Faltas provocadas'] || 0, 10);
                    playerStats[player].penaltisParados += parseInt(fields['Penaltis parados'] || 0, 10);
                    playerStats[player].partidosJugados += fields['Juega'] === 'S' ? 1 : 0;
                    playerStats[player].partidosGanados += parseInt(fields['Partido Ganado'] || 0, 10);
                    playerStats[player].golesPropia += parseInt(fields['Goles en Propia'] || 0, 10);
                    playerStats[player].puntosMVP += parseInt(fields['MVP'] || 0, 10);
                    playerStats[player].golesContribuidos = playerStats[player].goles + playerStats[player].asistencias;
                });

                const tableBodyGoles = document.querySelector('#goles-contribuidos-body');
                const tableBodyMVP = document.querySelector('#mvp-points-body');
                const tableBodyGanadores = document.querySelector('#winning-matches-body');

                // Assuming playerStats is already populated
                const players = Object.values(playerStats);

                // Function to sort players by multiple criteria
                const sortPlayers = (players, sortBy, secondarySortBy) => {
                    return players.slice().sort((a, b) => {
                        // Primary sort
                        if (b[sortBy] !== a[sortBy]) {
                            return b[sortBy] - a[sortBy];
                        }
                        // Secondary sort (alphabetical order)
                        return a.jugador.localeCompare(b.jugador);
                    });
                };

                // Sort players by different criteria
                const sortedByGoles = sortPlayers(players, 'golesContribuidos', 'jugador');
                const sortedByMVP = sortPlayers(players, 'puntosMVP', 'jugador');
                const sortedByVictorias = sortPlayers(players, 'partidosGanados', 'jugador');

                // Function to generate table rows
                const generateTableRows = (players, rank, tableBody, columns) => {
                    const processedPlayers = new Set();  // Track players that have already been added 
                    players.slice(0, 5).forEach((player) => {
                        const { jugador, goles, asistencias, golesContribuidos, puntosMVP, partidosGanados } = player;

                        // Skip if the player is already processed
                        if (processedPlayers.has(jugador)) {
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rank}</td>
                            <td>${jugador}</td>
                            ${columns.map(column => `<td>${column(player)}</td>`).join('')}
                        `;
                        tableBody.appendChild(row);

                        processedPlayers.add(jugador); // Mark the player as processed
                        rank++;
                    });
                };


                // Insert data into each table
                let rank = 1;

                // Top Goles Contribuidos Table
                generateTableRows(sortedByGoles, rank, tableBodyGoles, [
                    (player) => player.goles,
                    (player) => player.asistencias,
                    (player) => player.golesContribuidos,
                ]);

                rank = 1;  // Reset rank for the next table
                // Top MVP Table
                generateTableRows(sortedByMVP, rank, tableBodyMVP, [
                    (player) => player.puntosMVP
                ]);

                rank = 1;  // Reset rank for the next table
                // Top Ganadores Table
                generateTableRows(sortedByVictorias, rank, tableBodyGanadores, [
                    (player) => player.partidosGanados
                ]);

            } catch (error) {
                console.error('Error fetching or processing data:', error);
            }
        }


        async function fetchMatches() {
        const airtableApiKey = 'patp3kkpRn8eGNX3y.db99d2833bad3cfb3ed32a4377304090f84839a464e55ffc8b1333a01cb5fdf3';
        const airtableBaseId = 'app9PTtjDQsuwHyIz';
        const matchesTableName = 'Table 2';
        const playersTableName = 'Table 1';
        const fotosPartidosTableName = 'FotosPartidos';
        const currentYear = new Date().getFullYear();
    
        const matchesUrl = `https://api.airtable.com/v0/${airtableBaseId}/${matchesTableName}`;
        const playersUrl = `https://api.airtable.com/v0/${airtableBaseId}/${playersTableName}`;
        const fotosUrl = `https://api.airtable.com/v0/${airtableBaseId}/${fotosPartidosTableName}`;

        try {

            const today = new Date();
            const [matchesResponse, playersResponse, fotosResponse] = await Promise.all([
                fetch(matchesUrl, {
                    headers: {
                        Authorization: `Bearer ${airtableApiKey}`
                    }
                }),
                fetch(playersUrl, {
                    headers: {
                        Authorization: `Bearer ${airtableApiKey}`
                    }
                }),
                fetch(fotosUrl, {
                    headers: {
                        Authorization: `Bearer ${airtableApiKey}`
                    }
                })
            ]);

            if (!matchesResponse.ok || !playersResponse.ok) {
                console.error('Failed to fetch matches or players');
                return;
            }
            if (!fotosResponse.ok) {
                console.error('Failed to fetch images');
                return;
            }

            const matchesData = await matchesResponse.json();
            const playersData = await playersResponse.json();
            const fotosData = await fotosResponse.json();

            const playersMap = playersData.records.reduce((map, record) => {
                map[record.id] = record.fields.Jugador; // Map player IDs to names
                return map;
            }, {});


            function parseCustomDate(fecha) {
                const [day, month] = fecha.split('/').map(Number);
                return new Date(today.getFullYear(), month - 1, day); // Use current year
            }

            const upcomingMatches = [];
            const pastMatches = [];

            matchesData.records.forEach((match) => {
                if (!match.fields.Fecha) return; // Skip records without a date
                const matchDate = parseCustomDate(match.fields.Fecha);
                if (matchDate >= today) {
                    upcomingMatches.push({ ...match, date: matchDate });
                } else {
                    pastMatches.push({ ...match, date: matchDate });
                }
            });

            const upcomingContainer = document.querySelector('#upcoming-matches');

            // Sort past matches in descending order (newest first)
            pastMatches.sort((a, b) => b.date - a.date);

            const pastContainer = document.querySelector('#past-matches');
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.textContent = 'Ver más';
            loadMoreBtn.className = 'load-more-btn';
            
            let matchesDisplayed = 1; // Start with the most recent match

            // Display upcoming matches
            upcomingMatches.forEach((match) => {
                const div = document.createElement('div');
                div.className = 'upcoming-match';

                div.innerHTML = `
                    <p><strong>${match.fields.Nombre}</strong></p>
                    <p>Date: ${match.date.toLocaleDateString()}</p>
                    <p>Players: ${(match.fields.Jugadores || [])
                        .map((id) => playersMap[id] || 'Unknown')
                        .join(', ')}</p>
                `;

                upcomingContainer.appendChild(div);
            });

            // Display last 3 past matches
            //const pastMatchesToShow = pastMatches.slice(-3).reverse(); // Last 3 matches

            function displayMatch(match) {
                const { Nombre, Resultado, Jugadores, Fecha } = match.fields;

                // Create match container
                const matchContainer = document.createElement('div');
                matchContainer.className = 'match-container';

                // Parse score
                if (!Resultado || !Resultado.includes('-')) return; // Skip if no score
                const [scoreA, scoreB] = Resultado.split('-');

                let winnerScore = scoreA, loserScore = scoreB;
                if (scoreA < scoreB) [winnerScore, loserScore] = [loserScore, winnerScore];

                // Score UI
                const scoreContainer = document.createElement('div');
                scoreContainer.className = 'score-container';

                const winnerColor = '#006eff', loserColor = '#dc3545';

                const leftCircle = document.createElement('div');
                leftCircle.className = 'score-circle';
                leftCircle.style.backgroundColor = winnerColor;

                const score = document.createElement('p');
                score.className = 'match-score';
                score.innerHTML = `<span class="score">${winnerScore}</span> - <span class="score">${loserScore}</span>`;

                const rightCircle = document.createElement('div');
                rightCircle.className = 'score-circle';
                rightCircle.style.backgroundColor = loserColor;

                scoreContainer.append(leftCircle, score, rightCircle);
                matchContainer.appendChild(scoreContainer);

                // Date
                const date = document.createElement('p');
                date.className = 'match-teams';
                date.innerHTML = `<strong>${Fecha}</strong>`;
                matchContainer.appendChild(date);

                // Find and add match image
                const fotosMap = fotosData.records.reduce((map, record) => {
                    if (record.fields.Fecha) map[record.fields.Fecha] = record.fields;
                    return map;
                }, {});

                if (fotosMap[Fecha] && fotosMap[Fecha].Grupo?.[0]?.url) {
                    const groupImage = document.createElement('img');
                    groupImage.className = 'group-image';
                    groupImage.src = fotosMap[Fecha].Grupo[0].url;
                    matchContainer.appendChild(groupImage);
                }

                // Add players section
                const playersSection = document.createElement('p');
                playersSection.className = 'match-players';
                playersSection.textContent = 'Players:';

                const playersList = document.createElement('ul');
                playersList.className = 'players-list';

                // Add containers for winners and losers
                const resultContainer = document.createElement('div');
                resultContainer.className = 'result-container';

                const winnersContainer = document.createElement('div');
                winnersContainer.className = 'winners';
                winnersContainer.innerHTML = `
                    <ul class="players-list" id="winners-list-${match.id}"></ul>
                `;

                const losersContainer = document.createElement('div');
                losersContainer.className = 'losers';
                losersContainer.innerHTML = `
                    <ul class="players-list" id="losers-list-${match.id}"></ul>
                `;

                // Add match image
/*                        const matchImage = document.createElement('p');
                score.className = 'match-image';
                score.innerHTML = `<span class="score">${winnerScore}</span> - <span class="score">${loserScore}</span>`;
                matchContainer.appendChild(score);
*/
                // Append winners and losers containers to the result container
                //resultContainer.appendChild(matchImage);
                resultContainer.appendChild(winnersContainer);
                resultContainer.appendChild(losersContainer);

                // Add the result container to the match container
                matchContainer.appendChild(resultContainer);

                // Add players to the correct side (winners or losers)
                const winnersList = resultContainer.querySelector(`#winners-list-${match.id}`);
                const losersList = resultContainer.querySelector(`#losers-list-${match.id}`);

                for (const playerId of Jugadores) {
                    const playerRecord = playersData.records.find((record) => record.id === playerId);

                    if (playerRecord) {
                        const playerName = playerRecord.fields.Jugador;
                        const partidoGanado = parseInt(playerRecord.fields['Partido Ganado'] || 0, 10); // Default to 0 if undefined
                        const playerSemana = playerRecord.fields.Semana;

                        // Check if the player's "Semana" matches the match's "Semana" and determine win/loss
                        const won = playerSemana === match.fields.Semana && partidoGanado === 1;

                                                
                        const playerItem = document.createElement('li');
                        playerItem.className = `player-item ${won ? 'won' : 'lost'}`;
                        playerItem.textContent = playerName;


                        if (won) {
                            winnersList.appendChild(playerItem);
                        } else {
                            losersList.appendChild(playerItem);
                        }
                    }
                }

            // matchContainer.appendChild(playersSection);
            // matchContainer.appendChild(winnersList);
            // matchContainer.appendChild(losersList);

                // Add spacing
                const spacing = document.createElement('p');
                spacing.innerHTML = '&nbsp;';
                matchContainer.appendChild(spacing);

                pastContainer.appendChild(matchContainer);
            }

            // Display the most recent match initially
            if (pastMatches.length > 0) {
                displayMatch(pastMatches[0]);
                if (pastMatches.length > 1) pastContainer.appendChild(loadMoreBtn);
            } else {
                pastContainer.innerHTML = `<p>No past matches available.</p>`;
            }

            // Load more matches on button click
            loadMoreBtn.addEventListener('click', () => {
                if (matchesDisplayed < pastMatches.length) {
                    displayMatch(pastMatches[matchesDisplayed]);
                    matchesDisplayed++;

                    // Move the button below the newly added match
                    pastContainer.appendChild(loadMoreBtn);

                    if (matchesDisplayed >= pastMatches.length) {
                        loadMoreBtn.remove(); // Hide button if no more matches
                    }
                }
            });

        }catch (error) {
                console.error('Error fetching or processing matches:', error);
            }
        }

    window.onload = () => {
        fetchTopPlayers();
        fetchMatches();
    };
</script>
</head>
<body>
    <header>
        <h1>LA PACHANGA</h1>
    </header>

    <div class="nav-container">
        <button class="menu-toggle">☰</button>
        <nav class="nav-links">
            <a href="players.html">JUGADORES</a>
            <a href="index.html">INICIO</a>
            <a href="stats.html">ESTADISTICAS</a>
        </nav>
    </div>

    <script>
        document.querySelector(".menu-toggle").addEventListener("click", function() {
            document.querySelector(".nav-links").classList.toggle("active");
        });
    </script>

    <main>
        <div class="section">
            <h2>SIGUIENTES PARTIDOS</h2>
            <div id="upcoming-matches">
                <!-- Matches will be dynamically added here -->
            </div>
        </div>


        <section class="top-players">
            <div class="table-container">
                <h2>Top MVP</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Jugador</th>
                            <th>Puntos MVP</th>
                        </tr>
                    </thead>
                    <tbody id="mvp-points-body">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>


        <div class="table-container">
            <h2>Top Goles Contribuidos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Jugador</th>
                        <th>Goles</th>
                        <th>Asistencias</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="goles-contribuidos-body">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h2>Top Ganadores</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Jugador</th>
                        <th>Victorias</th>
                    </tr>
                </thead>
                <tbody id="winning-matches-body">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>

    </section>
    <div class="see-more">
        <a href="stats.html">Ver más</a>
    </div>

        <div class="section">
            <h2>RESULTADOS ANTERIORES</h2>
            <div id="past-matches" class="matches-container">
                <!-- Last matches will be dynamically added here -->
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; All Rights Reserved</p>
    </footer>
</body>
</html>


